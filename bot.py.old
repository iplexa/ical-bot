import asyncio
import logging
import datetime
from typing import Dict, List, Optional, Union

from aiogram import Bot, Dispatcher, types
from aiogram.contrib.fsm_storage.memory import MemoryStorage
from aiogram.dispatcher import FSMContext
from aiogram.dispatcher.filters.state import State, StatesGroup
from aiogram.types import InlineKeyboardMarkup, InlineKeyboardButton, CallbackQuery
from aiogram.utils.exceptions import MessageNotModified

from dateutil import tz
from sqlalchemy.orm import Session

# –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é –∏ —É—Ç–∏–ª–∏—Ç—ã –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –∫–∞–ª–µ–Ω–¥–∞—Ä–µ–º
from config import BOT_TOKEN, CHECK_INTERVAL, NOTIFICATION_TIME, OWNER_ID
from calendar_utils import fetch_calendar, get_events, format_events_text
from models import User, Calendar, init_db, SessionLocal
from db_utils import get_or_create_user, update_user_subscription, set_user_admin, get_all_subscribed_users, get_calendar, create_or_update_calendar

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
logging.basicConfig(level=logging.INFO)

# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –±–æ—Ç–∞ –∏ –¥–∏—Å–ø–µ—Ç—á–µ—Ä–∞
bot = Bot(token=BOT_TOKEN)
dp = Dispatcher(bot, storage=MemoryStorage())

# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
init_db()

# –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏–π –¥–ª—è FSM
class CalendarStates(StatesGroup):
    waiting_for_calendar_url = State()

class AdminStates(StatesGroup):
    waiting_for_admin_id = State()

# –°–æ–∑–¥–∞–Ω–∏–µ –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã –¥–ª—è –≥–ª–∞–≤–Ω–æ–≥–æ –º–µ–Ω—é
def get_main_keyboard(user: User = None, has_calendar: bool = False) -> InlineKeyboardMarkup:
    keyboard = InlineKeyboardMarkup(row_width=1)
    
    if has_calendar:
        # –ö–Ω–æ–ø–∫–∏ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ —Å–æ–±—ã—Ç–∏–π
        keyboard.add(
            InlineKeyboardButton("–°–æ–±—ã—Ç–∏—è –Ω–∞ —Å–µ–≥–æ–¥–Ω—è", callback_data="events_1"),
            InlineKeyboardButton("–°–æ–±—ã—Ç–∏—è –Ω–∞ 3 –¥–Ω—è", callback_data="events_3"),
            InlineKeyboardButton("–°–æ–±—ã—Ç–∏—è –Ω–∞ –Ω–µ–¥–µ–ª—é", callback_data="events_7")
        )
        
        # –ö–Ω–æ–ø–∫–∞ –ø–æ–¥–ø–∏—Å–∫–∏/–æ—Ç–ø–∏—Å–∫–∏
        is_subscribed = user.is_subscribed if user else False
        sub_text = "–û—Ç–∫–ª—é—á–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è" if is_subscribed else "–í–∫–ª—é—á–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è"
        sub_data = "unsubscribe" if is_subscribed else "subscribe"
        keyboard.add(InlineKeyboardButton(sub_text, callback_data=sub_data))
        
        # –ö–Ω–æ–ø–∫–∏ –¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤ –∏ –≤–ª–∞–¥–µ–ª—å—Ü–∞
        if user and (user.is_admin or user.is_owner):
            keyboard.add(InlineKeyboardButton("–ò–∑–º–µ–Ω–∏—Ç—å –∫–∞–ª–µ–Ω–¥–∞—Ä—å", callback_data="change_calendar"))
            
            # –ö–Ω–æ–ø–∫–∞ –¥–ª—è –≤–ª–∞–¥–µ–ª—å—Ü–∞ (—É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞–º–∏)
            if user.is_owner:
                keyboard.add(InlineKeyboardButton("–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞–º–∏", callback_data="manage_admins"))
    else:
        # –ö–Ω–æ–ø–∫–∞ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∫–∞–ª–µ–Ω–¥–∞—Ä—è (—Ç–æ–ª—å–∫–æ –¥–ª—è –∞–¥–º–∏–Ω–æ–≤ –∏ –≤–ª–∞–¥–µ–ª—å—Ü–∞)
        if user and (user.is_admin or user.is_owner):
            keyboard.add(InlineKeyboardButton("–î–æ–±–∞–≤–∏—Ç—å –∫–∞–ª–µ–Ω–¥–∞—Ä—å", callback_data="add_calendar"))
        else:
            keyboard.add(InlineKeyboardButton("–ó–∞–ø—Ä–æ—Å–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ –∫–∞–ª–µ–Ω–¥–∞—Ä—é", callback_data="request_calendar"))
    
    return keyboard

# –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /start
@dp.message_handler(commands=['start'], state='*')
async def cmd_start(message: types.Message, state: FSMContext):
    await state.finish()
    user_id = message.from_user.id
    
    # –ü–æ–ª—É—á–∞–µ–º –∏–ª–∏ —Å–æ–∑–¥–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö
    db = SessionLocal()
    try:
        user = get_or_create_user(
            db, 
            user_id, 
            message.from_user.username, 
            message.from_user.first_name, 
            message.from_user.last_name
        )
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –∫–∞–ª–µ–Ω–¥–∞—Ä—å –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö
        calendar = get_calendar(db)
        has_calendar = calendar is not None
        
        text = "–ü—Ä–∏–≤–µ—Ç! –Ø –±–æ—Ç –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –∫–∞–ª–µ–Ω–¥–∞—Ä—è–º–∏ –≤ —Ñ–æ—Ä–º–∞—Ç–µ iCal.\n\n"
        
        if has_calendar:
            text += "–ö–∞–ª–µ–Ω–¥–∞—Ä—å —É–∂–µ –¥–æ–±–∞–≤–ª–µ–Ω. –í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ:"
        else:
            if user.is_admin or user.is_owner:
                text += "–î–ª—è –Ω–∞—á–∞–ª–∞ —Ä–∞–±–æ—Ç—ã –¥–æ–±–∞–≤—å—Ç–µ —Å—Å—ã–ª–∫—É –Ω–∞ iCal –∫–∞–ª–µ–Ω–¥–∞—Ä—å."
            else:
                text += "–û–∂–∏–¥–∞–π—Ç–µ, –∫–æ–≥–¥–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –¥–æ–±–∞–≤–∏—Ç –∫–∞–ª–µ–Ω–¥–∞—Ä—å."
        
        await message.answer(
            text,
            reply_markup=get_main_keyboard(user, has_calendar)
        )
    finally:
        db.close()

# –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∫–∞–ª–µ–Ω–¥–∞—Ä—è
@dp.callback_query_handler(lambda c: c.data == 'add_calendar' or c.data == 'change_calendar', state='*')
async def process_add_calendar(callback_query: CallbackQuery, state: FSMContext):
    await bot.answer_callback_query(callback_query.id)
    
    user_id = callback_query.from_user.id
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞
    db = SessionLocal()
    try:
        user = get_or_create_user(db, user_id, callback_query.from_user.username,
                                callback_query.from_user.first_name, callback_query.from_user.last_name)
        
        if not user.is_admin and not user.is_owner:
            await bot.edit_message_text(
                "–£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è –∫–∞–ª–µ–Ω–¥–∞—Ä—è.",
                user_id,
                callback_query.message.message_id,
                reply_markup=get_main_keyboard(user, get_calendar(db) is not None)
            )
            return
        
        text = "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ—Ç–ø—Ä–∞–≤—å—Ç–µ —Å—Å—ã–ª–∫—É –Ω–∞ iCal –∫–∞–ª–µ–Ω–¥–∞—Ä—å."
        await bot.edit_message_text(
            text,
            user_id,
            callback_query.message.message_id,
            reply_markup=InlineKeyboardMarkup().add(
                InlineKeyboardButton("–û—Ç–º–µ–Ω–∞", callback_data="cancel")
            )
        )
        
        await CalendarStates.waiting_for_calendar_url.set()
    finally:
        db.close()

# –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –æ—Ç–º–µ–Ω—ã –æ–ø–µ—Ä–∞—Ü–∏–∏
@dp.callback_query_handler(lambda c: c.data == 'cancel', state='*')
async def process_cancel(callback_query: CallbackQuery, state: FSMContext):
    await bot.answer_callback_query(callback_query.id)
    await state.finish()
    
    user_id = callback_query.from_user.id
    
    # –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ –ë–î
    db = SessionLocal()
    try:
        user = get_or_create_user(db, user_id, callback_query.from_user.username,
                                callback_query.from_user.first_name, callback_query.from_user.last_name)
        calendar = get_calendar(db)
        
        text = "–û–ø–µ—Ä–∞—Ü–∏—è –æ—Ç–º–µ–Ω–µ–Ω–∞. –í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ:"
        await bot.edit_message_text(
            text,
            user_id,
            callback_query.message.message_id,
            reply_markup=get_main_keyboard(user, calendar is not None)
        )
    finally:
        db.close()

# –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è URL –∫–∞–ª–µ–Ω–¥–∞—Ä—è
@dp.message_handler(state=CalendarStates.waiting_for_calendar_url)
async def process_calendar_url(message: types.Message, state: FSMContext):
    url = message.text.strip()
    user_id = message.from_user.id
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º URL
    if not url.startswith(('http://', 'https://')):
        await message.answer(
            "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ—Ç–ø—Ä–∞–≤—å—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—É—é —Å—Å—ã–ª–∫—É –Ω–∞ –∫–∞–ª–µ–Ω–¥–∞—Ä—å, –Ω–∞—á–∏–Ω–∞—é—â—É—é—Å—è —Å http:// –∏–ª–∏ https://",
            reply_markup=InlineKeyboardMarkup().add(
                InlineKeyboardButton("–û—Ç–º–µ–Ω–∞", callback_data="cancel")
            )
        )
        return
    
    # –ü—Ä–æ–±—É–µ–º –∑–∞–≥—Ä—É–∑–∏—Ç—å –∫–∞–ª–µ–Ω–¥–∞—Ä—å
    calendar = await fetch_calendar(url)
    if not calendar:
        await message.answer(
            "–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∫–∞–ª–µ–Ω–¥–∞—Ä—å –ø–æ —É–∫–∞–∑–∞–Ω–Ω–æ–π —Å—Å—ã–ª–∫–µ. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø—Ä–æ–≤–µ—Ä—å—Ç–µ —Å—Å—ã–ª–∫—É –∏ –ø–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.",
            reply_markup=InlineKeyboardMarkup().add(
                InlineKeyboardButton("–û—Ç–º–µ–Ω–∞", callback_data="cancel")
            )
        )
        return
    
    # –°–æ—Ö—Ä–∞–Ω—è–µ–º URL –∫–∞–ª–µ–Ω–¥–∞—Ä—è –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö
    db = SessionLocal()
    try:
        user = get_or_create_user(db, user_id, message.from_user.username,
                                message.from_user.first_name, message.from_user.last_name)
        
        # –°–æ–∑–¥–∞–µ–º –∏–ª–∏ –æ–±–Ω–æ–≤–ª—è–µ–º –∫–∞–ª–µ–Ω–¥–∞—Ä—å
        create_or_update_calendar(db, url, user_id)
        
        await state.finish()
        
        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ–º
        sent_message = await message.answer(
            "–ö–∞–ª–µ–Ω–¥–∞—Ä—å —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω! –í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ:",
            reply_markup=get_main_keyboard(user, True)
        )
        
        # –£–¥–∞–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ —Å URL –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
        await message.delete()
    finally:
        db.close()

# –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ —Å–æ–±—ã—Ç–∏–π
@dp.callback_query_handler(lambda c: c.data.startswith('events_'))
async def process_show_events(callback_query: CallbackQuery):
    await bot.answer_callback_query(callback_query.id)
    
    user_id = callback_query.from_user.id
    
    # –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
    db = SessionLocal()
    try:
        user = get_or_create_user(db, user_id, callback_query.from_user.username,
                                callback_query.from_user.first_name, callback_query.from_user.last_name)
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –∫–∞–ª–µ–Ω–¥–∞—Ä—å
        calendar_obj = get_calendar(db)
        if not calendar_obj:
            await bot.edit_message_text(
                "–°–Ω–∞—á–∞–ª–∞ –¥–æ–±–∞–≤—å—Ç–µ –∫–∞–ª–µ–Ω–¥–∞—Ä—å.",
                user_id,
                callback_query.message.message_id,
                reply_markup=get_main_keyboard(user, False)
            )
            return
        
        # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –ø–µ—Ä–∏–æ–¥
        days = int(callback_query.data.split('_')[1])
        start_date = datetime.datetime.now(tz.tzlocal())
        end_date = start_date + datetime.timedelta(days=days)
        
        # –ó–∞–≥—Ä—É–∂–∞–µ–º –∫–∞–ª–µ–Ω–¥–∞—Ä—å
        calendar = await fetch_calendar(calendar_obj.url)
        if not calendar:
            await bot.edit_message_text(
                "–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∫–∞–ª–µ–Ω–¥–∞—Ä—å. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø—Ä–æ–≤–µ—Ä—å—Ç–µ —Å—Å—ã–ª–∫—É –∏ –ø–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.",
                user_id,
                callback_query.message.message_id,
                reply_markup=get_main_keyboard(user, True)
            )
            return
    finally:
        db.close()
    
    # –ü–æ–ª—É—á–∞–µ–º —Å–æ–±—ã—Ç–∏—è
    events = get_events(calendar, start_date, end_date)
    
    # –§–æ—Ä–º–∏—Ä—É–µ–º —Ç–µ–∫—Å—Ç —Å —Å–æ–±—ã—Ç–∏—è–º–∏
    period_text = "—Å–µ–≥–æ–¥–Ω—è" if days == 1 else f"–Ω–∞ {days} {'–¥–Ω—è' if days == 3 else '–¥–Ω–µ–π'}"
    text = f"–°–æ–±—ã—Ç–∏—è {period_text}:\n\n"
    text += format_events_text(events)
    
    # –î–æ–±–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É –≤–æ–∑–≤—Ä–∞—Ç–∞
    keyboard = InlineKeyboardMarkup().add(
        InlineKeyboardButton("–ù–∞–∑–∞–¥", callback_data="back_to_main")
    )
    
    try:
        await bot.edit_message_text(
            text,
            user_id,
            callback_query.message.message_id,
            reply_markup=keyboard
        )
    except MessageNotModified:
        # –ï—Å–ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ –Ω–µ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å, –∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º –æ—à–∏–±–∫—É
        pass

# –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –≤–æ–∑–≤—Ä–∞—Ç–∞ –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é
@dp.callback_query_handler(lambda c: c.data == 'back_to_main')
async def process_back_to_main(callback_query: CallbackQuery):
    await bot.answer_callback_query(callback_query.id)
    
    user_id = callback_query.from_user.id
    
    # –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
    db = SessionLocal()
    try:
        user = get_or_create_user(db, user_id, callback_query.from_user.username,
                                callback_query.from_user.first_name, callback_query.from_user.last_name)
        calendar = get_calendar(db)
        has_calendar = calendar is not None
        
        text = "–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ:"
        await bot.edit_message_text(
            text,
            user_id,
            callback_query.message.message_id,
            reply_markup=get_main_keyboard(user, has_calendar)
        )
    finally:
        db.close()

# –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –ø–æ–¥–ø–∏—Å–∫–∏/–æ—Ç–ø–∏—Å–∫–∏
@dp.callback_query_handler(lambda c: c.data == 'subscribe')
async def process_subscribe(callback_query: CallbackQuery):
    await bot.answer_callback_query(callback_query.id)
    
    user_id = callback_query.from_user.id
    
    # –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –ø–æ–¥–ø–∏—Å–∫–∏ –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö
    db = SessionLocal()
    try:
        user = get_or_create_user(db, user_id, callback_query.from_user.username,
                                callback_query.from_user.first_name, callback_query.from_user.last_name)
        
        # –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –ø–æ–¥–ø–∏—Å–∫–∏
        update_user_subscription(db, user_id, True)
        user.is_subscribed = True  # –û–±–Ω–æ–≤–ª—è–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–π –æ–±—ä–µ–∫—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        
        await bot.edit_message_text(
            "–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ —Å–æ–±—ã—Ç–∏—è—Ö –≤–∫–ª—é—á–µ–Ω—ã! –í—ã –±—É–¥–µ—Ç–µ –ø–æ–ª—É—á–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è –æ –Ω–∞—á–∞–ª–µ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π.",
            user_id,
            callback_query.message.message_id,
            reply_markup=get_main_keyboard(user, True)
        )
    finally:
        db.close()

@dp.callback_query_handler(lambda c: c.data == 'unsubscribe')
async def process_unsubscribe(callback_query: CallbackQuery):
    await bot.answer_callback_query(callback_query.id)
    
    user_id = callback_query.from_user.id
    
    # –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –ø–æ–¥–ø–∏—Å–∫–∏ –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö
    db = SessionLocal()
    try:
        user = get_or_create_user(db, user_id, callback_query.from_user.username,
                                callback_query.from_user.first_name, callback_query.from_user.last_name)
        
        # –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –ø–æ–¥–ø–∏—Å–∫–∏
        update_user_subscription(db, user_id, False)
        user.is_subscribed = False  # –û–±–Ω–æ–≤–ª—è–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–π –æ–±—ä–µ–∫—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        
        await bot.edit_message_text(
            "–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ —Å–æ–±—ã—Ç–∏—è—Ö –æ—Ç–∫–ª—é—á–µ–Ω—ã.",
            user_id,
            callback_query.message.message_id,
            reply_markup=get_main_keyboard(user, False)
        )
    finally:
        db.close()

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–µ–¥—Å—Ç–æ—è—â–∏—Ö —Å–æ–±—ã—Ç–∏–π –∏ –æ—Ç–ø—Ä–∞–≤–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
async def check_upcoming_events():
    while True:
        now = datetime.datetime.now(tz.tzlocal())
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ–±—ã—Ç–∏—è –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –ø–æ–¥–ø–∏—Å–∞–Ω–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        for user_id, data in user_data.items():
            if data.get('subscribed', False) and 'calendar_url' in data:
                try:
                    # –ó–∞–≥—Ä—É–∂–∞–µ–º –∫–∞–ª–µ–Ω–¥–∞—Ä—å
                    calendar = await fetch_calendar(data['calendar_url'])
                    if not calendar:
                        continue
                    
                    # –ü–æ–ª—É—á–∞–µ–º —Å–æ–±—ã—Ç–∏—è –Ω–∞ –±–ª–∏–∂–∞–π—à–∏–π —á–∞—Å
                    end_time = now + datetime.timedelta(hours=1)
                    events = get_events(calendar, now, end_time)
                    
                    # –§–∏–ª—å—Ç—Ä—É–µ–º —Å–æ–±—ã—Ç–∏—è, –∫–æ—Ç–æ—Ä—ã–µ –Ω–∞—á–∏–Ω–∞—é—Ç—Å—è –≤ —Ç–µ—á–µ–Ω–∏–µ 15 –º–∏–Ω—É—Ç
                    for event in events:
                        event_start = event['start']
                        time_diff = (event_start - now).total_seconds() / 60
                        
                        # –ï—Å–ª–∏ —Å–æ–±—ã—Ç–∏–µ –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è –≤ —Ç–µ—á–µ–Ω–∏–µ –∑–∞–¥–∞–Ω–Ω–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏ –∏ –º—ã –µ—â–µ –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è–ª–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
                        event_id = f"{event['summary']}_{event_start.isoformat()}"
                        if 0 <= time_diff <= NOTIFICATION_TIME and event_id not in data.get('notified_events', set()):
                            # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
                            text = f"üîî –°–∫–æ—Ä–æ –Ω–∞—á–Ω–µ—Ç—Å—è —Å–æ–±—ã—Ç–∏–µ!\n\n"
                            text += f"üïí {event_start.strftime('%d.%m.%Y %H:%M')}\n"
                            text += f"üìå {event['summary']}\n"
                            
                            if event['location'] != '–ë–µ–∑ –º–µ—Å—Ç–∞':
                                text += f"üìç {event['location']}\n"
                            
                            if event['description'] != '–ë–µ–∑ –æ–ø–∏—Å–∞–Ω–∏—è':
                                text += f"‚ÑπÔ∏è {event['description']}\n"
                            
                            await bot.send_message(user_id, text)
                            
                            # –û—Ç–º–µ—á–∞–µ–º —Å–æ–±—ã—Ç–∏–µ –∫–∞–∫ —É–≤–µ–¥–æ–º–ª–µ–Ω–Ω–æ–µ
                            if 'notified_events' not in data:
                                data['notified_events'] = set()
                            data['notified_events'].add(event_id)
                except Exception as e:
                    logging.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ —Å–æ–±—ã—Ç–∏–π –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user_id}: {e}")
        
        # –û—á–∏—â–∞–µ–º —Å—Ç–∞—Ä—ã–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è (—Å—Ç–∞—Ä—à–µ 24 —á–∞—Å–æ–≤)
        for user_id, data in user_data.items():
            if 'notified_events' in data:
                # –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π –Ω–∞–±–æ—Ä –±–µ–∑ —Å—Ç–∞—Ä—ã—Ö —Å–æ–±—ã—Ç–∏–π
                data['notified_events'] = {event_id for event_id in data['notified_events'] 
                                          if not event_id.split('_')[1].startswith((now - datetime.timedelta(days=1)).isoformat()[:10])}
        
        # –ñ–¥–µ–º –∑–∞–¥–∞–Ω–Ω–æ–µ –≤—Ä–µ–º—è –ø–µ—Ä–µ–¥ —Å–ª–µ–¥—É—é—â–µ–π –ø—Ä–æ–≤–µ—Ä–∫–æ–π
        await asyncio.sleep(CHECK_INTERVAL)

# –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞–º–∏
@dp.callback_query_handler(lambda c: c.data == 'manage_admins')
async def process_manage_admins(callback_query: CallbackQuery):
    await bot.answer_callback_query(callback_query.id)
    
    user_id = callback_query.from_user.id
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–ª–∞–¥–µ–ª—å—Ü–µ–º
    db = SessionLocal()
    try:
        user = get_or_create_user(db, user_id, callback_query.from_user.username,
                                callback_query.from_user.first_name, callback_query.from_user.last_name)
        
        if not user.is_owner:
            await bot.edit_message_text(
                "–£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞–º–∏.",
                user_id,
                callback_query.message.message_id,
                reply_markup=get_main_keyboard(user, get_calendar(db) is not None)
            )
            return
        
        # –°–æ–∑–¥–∞–µ–º –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞–º–∏
        keyboard = InlineKeyboardMarkup(row_width=1)
        keyboard.add(
            InlineKeyboardButton("–î–æ–±–∞–≤–∏—Ç—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞", callback_data="add_admin"),
            InlineKeyboardButton("–£–¥–∞–ª–∏—Ç—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞", callback_data="remove_admin"),
            InlineKeyboardButton("–ù–∞–∑–∞–¥", callback_data="back_to_main")
        )
        
        await bot.edit_message_text(
            "–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞–º–∏:",
            user_id,
            callback_query.message.message_id,
            reply_markup=keyboard
        )
    finally:
        db.close()

# –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
@dp.callback_query_handler(lambda c: c.data == 'add_admin')
async def process_add_admin(callback_query: CallbackQuery, state: FSMContext):
    await bot.answer_callback_query(callback_query.id)
    
    user_id = callback_query.from_user.id
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–ª–∞–¥–µ–ª—å—Ü–µ–º
    db = SessionLocal()
    try:
        user = get_or_create_user(db, user_id, callback_query.from_user.username,
                                callback_query.from_user.first_name, callback_query.from_user.last_name)
        
        if not user.is_owner:
            await bot.edit_message_text(
                "–£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞–º–∏.",
                user_id,
                callback_query.message.message_id,
                reply_markup=get_main_keyboard(user, get_calendar(db) is not None)
            )
            return
        
        # –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º ID –Ω–æ–≤–æ–≥–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
        await bot.edit_message_text(
            "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ—Ç–ø—Ä–∞–≤—å—Ç–µ ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, –∫–æ—Ç–æ—Ä–æ–≥–æ —Ö–æ—Ç–∏—Ç–µ —Å–¥–µ–ª–∞—Ç—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º.",
            user_id,
            callback_query.message.message_id,
            reply_markup=InlineKeyboardMarkup().add(
                InlineKeyboardButton("–û—Ç–º–µ–Ω–∞", callback_data="cancel")
            )
        )
        
        # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –æ–∂–∏–¥–∞–Ω–∏—è ID –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
        await AdminStates.waiting_for_admin_id.set()
    finally:
        db.close()

# –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è ID –Ω–æ–≤–æ–≥–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
@dp.message_handler(state=AdminStates.waiting_for_admin_id)
async def process_admin_id(message: types.Message, state: FSMContext):
    user_id = message.from_user.id
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–ª–∞–¥–µ–ª—å—Ü–µ–º
    db = SessionLocal()
    try:
        user = get_or_create_user(db, user_id, message.from_user.username,
                                message.from_user.first_name, message.from_user.last_name)
        
        if not user.is_owner:
            await message.answer(
                "–£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞–º–∏.",
                reply_markup=get_main_keyboard(user, get_calendar(db) is not None)
            )
            await state.finish()
            return
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å –≤–≤–µ–¥–µ–Ω–Ω–æ–≥–æ ID
        try:
            admin_id = int(message.text.strip())
        except ValueError:
            await message.answer(
                "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (—Ü–µ–ª–æ–µ —á–∏—Å–ª–æ).",
                reply_markup=InlineKeyboardMarkup().add(
                    InlineKeyboardButton("–û—Ç–º–µ–Ω–∞", callback_data="cancel")
                )
            )
            return
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å —Ç–∞–∫–∏–º ID
        admin_user = get_user(db, admin_id)
        if not admin_user:
            # –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–µ—Ç –≤ –±–∞–∑–µ, —Å–æ–∑–¥–∞–µ–º –µ–≥–æ
            admin_user = create_user(db, admin_id)
        
        # –ù–∞–∑–Ω–∞—á–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º
        set_user_admin(db, admin_id, True)
        
        await state.finish()
        
        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± —É—Å–ø–µ—à–Ω–æ–º –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–∏
        await message.answer(
            f"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å ID {admin_id} —É—Å–ø–µ—à–Ω–æ –Ω–∞–∑–Ω–∞—á–µ–Ω –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º.",
            reply_markup=InlineKeyboardMarkup().add(
                InlineKeyboardButton("–ù–∞–∑–∞–¥ –∫ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—é", callback_data="manage_admins")
            )
        )
    finally:
        db.close()

# –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
@dp.callback_query_handler(lambda c: c.data == 'remove_admin')
async def process_remove_admin(callback_query: CallbackQuery, state: FSMContext):
    await bot.answer_callback_query(callback_query.id)
    
    user_id = callback_query.from_user.id
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–ª–∞–¥–µ–ª—å—Ü–µ–º
    db = SessionLocal()
    try:
        user = get_or_create_user(db, user_id, callback_query.from_user.username,
                                callback_query.from_user.first_name, callback_query.from_user.last_name)
        
        if not user.is_owner:
            await bot.edit_message_text(
                "–£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞–º–∏.",
                user_id,
                callback_query.message.message_id,
                reply_markup=get_main_keyboard(user, get_calendar(db) is not None)
            )
            return
        
        # –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º ID –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è
        await bot.edit_message_text(
            "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ—Ç–ø—Ä–∞–≤—å—Ç–µ ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, —É –∫–æ—Ç–æ—Ä–æ–≥–æ —Ö–æ—Ç–∏—Ç–µ —É–±—Ä–∞—Ç—å –ø—Ä–∞–≤–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞.",
            user_id,
            callback_query.message.message_id,
            reply_markup=InlineKeyboardMarkup().add(
                InlineKeyboardButton("–û—Ç–º–µ–Ω–∞", callback_data="cancel")
            )
        )
        
        # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –æ–∂–∏–¥–∞–Ω–∏—è ID –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
        await AdminStates.waiting_for_admin_id.set()
        
        # –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ç–æ–º, —á—Ç–æ —ç—Ç–æ —É–¥–∞–ª–µ–Ω–∏–µ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
        await state.update_data(action="remove_admin")
    finally:
        db.close()

# –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –∑–∞–ø—Ä–æ—Å–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –∫–∞–ª–µ–Ω–¥–∞—Ä—é
@dp.callback_query_handler(lambda c: c.data == 'request_calendar')
async def process_request_calendar(callback_query: CallbackQuery):
    await bot.answer_callback_query(callback_query.id)
    
    user_id = callback_query.from_user.id
    
    # –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    db = SessionLocal()
    try:
        user = get_or_create_user(db, user_id, callback_query.from_user.username,
                                callback_query.from_user.first_name, callback_query.from_user.last_name)
        
        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –≤–ª–∞–¥–µ–ª—å—Ü—É –±–æ—Ç–∞
        owner_id = OWNER_ID
        if owner_id:
            username = callback_query.from_user.username or "–±–µ–∑ –∏–º–µ–Ω–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"
            full_name = f"{callback_query.from_user.first_name or ''} {callback_query.from_user.last_name or ''}".strip() or "–±–µ–∑ –∏–º–µ–Ω–∏"
            
            await bot.send_message(
                owner_id,
                f"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å @{username} ({full_name}, ID: {user_id}) –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç –¥–æ—Å—Ç—É–ø –∫ –∫–∞–ª–µ–Ω–¥–∞—Ä—é.",
                reply_markup=InlineKeyboardMarkup().add(
                    InlineKeyboardButton("–°–¥–µ–ª–∞—Ç—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º", callback_data=f"make_admin_{user_id}")
                )
            )
            
            # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
            await bot.edit_message_text(
                "–ó–∞–ø—Ä–æ—Å –Ω–∞ –¥–æ—Å—Ç—É–ø –∫ –∫–∞–ª–µ–Ω–¥–∞—Ä—é –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –≤–ª–∞–¥–µ–ª—å—Ü—É –±–æ—Ç–∞. –û–∂–∏–¥–∞–π—Ç–µ –æ—Ç–≤–µ—Ç–∞.",
                user_id,
                callback_query.message.message_id,
                reply_markup=InlineKeyboardMarkup().add(
                    InlineKeyboardButton("–ù–∞–∑–∞–¥", callback_data="back_to_main")
                )
            )
        else:
            await bot.edit_message_text(
                "–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞–ø—Ä–æ—Å. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —Å–≤—è–∂–∏—Ç–µ—Å—å —Å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º –±–æ—Ç–∞ –Ω–∞–ø—Ä—è–º—É—é.",
                user_id,
                callback_query.message.message_id,
                reply_markup=InlineKeyboardMarkup().add(
                    InlineKeyboardButton("–ù–∞–∑–∞–¥", callback_data="back_to_main")
                )
            )
    finally:
        db.close()

# –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ –∏–∑ –∑–∞–ø—Ä–æ—Å–∞
@dp.callback_query_handler(lambda c: c.data.startswith('make_admin_'))
async def process_make_admin_from_request(callback_query: CallbackQuery):
    await bot.answer_callback_query(callback_query.id)
    
    user_id = callback_query.from_user.id
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–ª–∞–¥–µ–ª—å—Ü–µ–º
    db = SessionLocal()
    try:
        user = get_or_create_user(db, user_id, callback_query.from_user.username,
                                callback_query.from_user.first_name, callback_query.from_user.last_name)
        
        if not user.is_owner:
            await bot.edit_message_text(
                "–£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –¥–ª—è –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤.",
                user_id,
                callback_query.message.message_id
            )
            return
        
        # –ü–æ–ª—É—á–∞–µ–º ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º
        admin_id = int(callback_query.data.split('_')[2])
        
        # –ù–∞–∑–Ω–∞—á–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º
        admin_user = get_or_create_user(db, admin_id)
        set_user_admin(db, admin_id, True)
        
        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –≤–ª–∞–¥–µ–ª—å—Ü—É
        await bot.edit_message_text(
            f"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å ID {admin_id} —É—Å–ø–µ—à–Ω–æ –Ω–∞–∑–Ω–∞—á–µ–Ω –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º.",
            user_id,
            callback_query.message.message_id
        )
        
        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –Ω–æ–≤–æ–º—É –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É
        await bot.send_message(
            admin_id,
            "–í–∞–º –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω—ã –ø—Ä–∞–≤–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞. –¢–µ–ø–µ—Ä—å –≤—ã –º–æ–∂–µ—Ç–µ —É–ø—Ä–∞–≤–ª—è—Ç—å –∫–∞–ª–µ–Ω–¥–∞—Ä–µ–º.",
            reply_markup=get_main_keyboard(admin_user, get_calendar(db) is not None)
        )
    finally:
        db.close()

# –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –ø–æ–¥–ø–∏—Å–∫–∏/–æ—Ç–ø–∏—Å–∫–∏
@dp.callback_query_handler(lambda c: c.data == 'subscribe')
async def process_subscribe(callback_query: CallbackQuery):
    await bot.answer_callback_query(callback_query.id)
    
    user_id = callback_query.from_user.id
    
    # –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –ø–æ–¥–ø–∏—Å–∫–∏ –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö
    db = SessionLocal()
    try:
        user = get_or_create_user(db, user_id, callback_query.from_user.username,
                                callback_query.from_user.first_name, callback_query.from_user.last_name)
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –∫–∞–ª–µ–Ω–¥–∞—Ä—å
        calendar = get_calendar(db)
        if not calendar:
            await bot.edit_message_text(
                "–°–Ω–∞—á–∞–ª–∞ –¥–æ–±–∞–≤—å—Ç–µ –∫–∞–ª–µ–Ω–¥–∞—Ä—å.",
                user_id,
                callback_query.message.message_id,
                reply_markup=get_main_keyboard(user, False)
            )
            return
        
        # –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –ø–æ–¥–ø–∏—Å–∫–∏
        update_user_subscription(db, user_id, True)
        user.is_subscribed = True  # –û–±–Ω–æ–≤–ª—è–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–π –æ–±—ä–µ–∫—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        
        await bot.edit_message_text(
            "–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ —Å–æ–±—ã—Ç–∏—è—Ö –≤–∫–ª—é—á–µ–Ω—ã! –í—ã –±—É–¥–µ—Ç–µ –ø–æ–ª—É—á–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è –æ –Ω–∞—á–∞–ª–µ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π.",
            user_id,
            callback_query.message.message_id,
            reply_markup=get_main_keyboard(user, True)
        )
    finally:
        db.close()

@dp.callback_query_handler(lambda c: c.data == 'unsubscribe')
async def process_unsubscribe(callback_query: CallbackQuery):
    await bot.answer_callback_query(callback_query.id)
    
    user_id = callback_query.from_user.id
    
    # –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –ø–æ–¥–ø–∏—Å–∫–∏ –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö
    db = SessionLocal()
    try:
        user = get_or_create_user(db, user_id, callback_query.from_user.username,
                                callback_query.from_user.first_name, callback_query.from_user.last_name)
        
        # –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –ø–æ–¥–ø–∏—Å–∫–∏
        update_user_subscription(db, user_id, False)
        user.is_subscribed = False  # –û–±–Ω–æ–≤–ª—è–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–π –æ–±—ä–µ–∫—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        
        await bot.edit_message_text(
            "–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ —Å–æ–±—ã—Ç–∏—è—Ö –æ—Ç–∫–ª—é—á–µ–Ω—ã.",
            user_id,
            callback_query.message.message_id,
            reply_markup=get_main_keyboard(user, True)
        )
    finally:
        db.close()

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–µ–¥—Å—Ç–æ—è—â–∏—Ö —Å–æ–±—ã—Ç–∏–π –∏ –æ—Ç–ø—Ä–∞–≤–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
async def check_upcoming_events():
    while True:
        now = datetime.datetime.now(tz.tzlocal())
        
        # –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ—Ö –ø–æ–¥–ø–∏—Å–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∏ –∫–∞–ª–µ–Ω–¥–∞—Ä—å –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
        db = SessionLocal()
        try:
            # –ü–æ–ª—É—á–∞–µ–º –∫–∞–ª–µ–Ω–¥–∞—Ä—å
            calendar_obj = get_calendar(db)
            if not calendar_obj:
                # –ï—Å–ª–∏ –∫–∞–ª–µ–Ω–¥–∞—Ä—è –Ω–µ—Ç, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º –ø—Ä–æ–≤–µ—Ä–∫—É
                await asyncio.sleep(CHECK_INTERVAL)
                continue
            
            # –ó–∞–≥—Ä—É–∂–∞–µ–º –∫–∞–ª–µ–Ω–¥–∞—Ä—å
            calendar = await fetch_calendar(calendar_obj.url)
            if not calendar:
                # –ï—Å–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∫–∞–ª–µ–Ω–¥–∞—Ä—å, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º –ø—Ä–æ–≤–µ—Ä–∫—É
                await asyncio.sleep(CHECK_INTERVAL)
                continue
            
            # –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ—Ö –ø–æ–¥–ø–∏—Å–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
            subscribed_users = get_all_subscribed_users(db)
            
            # –ü–æ–ª—É—á–∞–µ–º —Å–æ–±—ã—Ç–∏—è –Ω–∞ –±–ª–∏–∂–∞–π—à–∏–π —á–∞—Å
            end_time = now + datetime.timedelta(hours=1)
            events = get_events(calendar, now, end_time)
            
            # –°–æ–∑–¥–∞–µ–º —Å–ª–æ–≤–∞—Ä—å –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
            notified_events = {}
            
            # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –ø–æ–¥–ø–∏—Å–∞–Ω–Ω—ã–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º
            for user in subscribed_users:
                user_id = user.user_id
                
                # –ï—Å–ª–∏ —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–µ—Ç —Å–ª–æ–≤–∞—Ä—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π, —Å–æ–∑–¥–∞–µ–º –µ–≥–æ
                if user_id not in notified_events:
                    notified_events[user_id] = set()
                
                # –§–∏–ª—å—Ç—Ä—É–µ–º —Å–æ–±—ã—Ç–∏—è, –∫–æ—Ç–æ—Ä—ã–µ –Ω–∞—á–∏–Ω–∞—é—Ç—Å—è –≤ —Ç–µ—á–µ–Ω–∏–µ –∑–∞–¥–∞–Ω–Ω–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏
                for event in events:
                    event_start = event['start']
                    time_diff = (event_start - now).total_seconds() / 60
                    
                    # –ï—Å–ª–∏ —Å–æ–±—ã—Ç–∏–µ –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è –≤ —Ç–µ—á–µ–Ω–∏–µ –∑–∞–¥–∞–Ω–Ω–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏ –∏ –º—ã –µ—â–µ –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è–ª–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
                    event_id = f"{event['summary']}_{event_start.isoformat()}"
                    if 0 <= time_diff <= NOTIFICATION_TIME and event_id not in notified_events[user_id]:
                        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
                        text = f"üîî –°–∫–æ—Ä–æ –Ω–∞—á–Ω–µ—Ç—Å—è —Å–æ–±—ã—Ç–∏–µ!\n\n"
                        text += f"üïí {event_start.strftime('%d.%m.%Y %H:%M')}\n"
                        text += f"üìå {event['summary']}\n"
                        
                        if event['location'] != '–ë–µ–∑ –º–µ—Å—Ç–∞':
                            text += f"üìç {event['location']}\n"
                        
                        if event['description'] != '–ë–µ–∑ –æ–ø–∏—Å–∞–Ω–∏—è':
                            text += f"‚ÑπÔ∏è {event['description']}\n"
                        
                        try:
                            await bot.send_message(user_id, text)
                            # –û—Ç–º–µ—á–∞–µ–º —Å–æ–±—ã—Ç–∏–µ –∫–∞–∫ —É–≤–µ–¥–æ–º–ª–µ–Ω–Ω–æ–µ
                            notified_events[user_id].add(event_id)
                        except Exception as e:
                            logging.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é {user_id}: {e}")
            
            # –û—á–∏—â–∞–µ–º —Å—Ç–∞—Ä—ã–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è (—Å—Ç–∞—Ä—à–µ 24 —á–∞—Å–æ–≤)
            for user_id in notified_events:
                notified_events[user_id] = {event_id for event_id in notified_events[user_id] 
                                          if not event_id.split('_')[1].startswith((now - datetime.timedelta(days=1)).isoformat()[:10])}
        
        except Exception as e:
            logging.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ —Å–æ–±—ã—Ç–∏–π: {e}")
        finally:
            db.close()
        
        # –ñ–¥–µ–º –∑–∞–¥–∞–Ω–Ω–æ–µ –≤—Ä–µ–º—è –ø–µ—Ä–µ–¥ —Å–ª–µ–¥—É—é—â–µ–π –ø—Ä–æ–≤–µ—Ä–∫–æ–π
        await asyncio.sleep(CHECK_INTERVAL)

# –ó–∞–ø—É—Å–∫ –±–æ—Ç–∞
async def main():
    # –ó–∞–ø—É—Å–∫–∞–µ–º –∑–∞–¥–∞—á—É –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å–æ–±—ã—Ç–∏–π
    asyncio.create_task(check_upcoming_events())
    
    # –ó–∞–ø—É—Å–∫–∞–µ–º –±–æ—Ç–∞
    await dp.start_polling()

if __name__ == '__main__':
    asyncio.run(main())